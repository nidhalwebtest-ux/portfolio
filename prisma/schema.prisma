// 1. Config
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// 2. Enums
enum UserRole {
  OWNER       // Pays the bills, full access
  MANAGER     // Can see all properties, but can't change billing
  STAFF       // Restricted to assigned properties only (Receptionist)
}

enum PropertyType {
  RESIDENTIAL
  COMMERCIAL
  HOTEL
}

enum ReservationStatus {
  PENDING
  CONFIRMED
  CHECKED_IN
  COMPLETED
  CANCELLED
}

// 3. The New Powerhouse: Organization
model Organization {
  id                String   @id @default(uuid())
  name              String   // e.g. "Salalah Real Estate Co."
  
  // Subscription / Limits Logic
  plan              String   @default("FREE") // FREE, STARTER, PRO
  maxProperties     Int      @default(1)
  subscriptionStatus String  @default("ACTIVE") // ACTIVE, PAST_DUE
  
  createdAt         DateTime @default(now())
  
  // Everything belongs to the Org now, not the User
  users             User[]
  properties        Property[]
  tenants           Tenant[]
}

// 4. Users (Staff Members)
model User {
  id             String       @id @default(uuid())
  email          String       @unique
  firstName      String?
  lastName       String?
  role           UserRole     @default(OWNER)
  
  // Link to Organization
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id])
  
  // Access Control: Which properties can this user see?
  assignedProperties PropertyAssignment[]

  createdAt      DateTime     @default(now())
}

// 5. Explicit Assignments (For Receptionists)
model PropertyAssignment {
  id          String   @id @default(uuid())
  
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  propertyId  String
  property    Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@unique([userId, propertyId]) // Prevent duplicate assignments
}

// 6. Properties
model Property {
  id             String   @id @default(uuid())
  name           String
  type           PropertyType @default(RESIDENTIAL)
  
  // Location
  address        String?
  city           String       @default("Salalah")
  governorate    String       @default("Dhofar")
  
  // Link to Org
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  // Relations
  units          Unit[]
  assignments    PropertyAssignment[] // Who works here?
  
  createdAt      DateTime @default(now())
}

// ... (Unit, Tenant, Reservation models remain mostly the same, 
// just ensure Tenant links to OrganizationId if you want shared tenants)

model Unit {
  id          String   @id @default(uuid())
  name        String   // e.g. "Room 101"
  floor       Int      @default(0)
  bedrooms    Int      @default(1)
  bathrooms   Int      @default(1)
  
  basePrice   Decimal  @db.Decimal(10, 2)
  
  propertyId  String
  property    Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  
  reservations Reservation[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Tenant {
  id             String   @id @default(uuid())
  
  firstName      String
  lastName       String   // Added this
  
  email          String?
  phone          String
  
  // Identity Fields (Added these for Omani context)
  nationalId     String?  
  nationality    String?
  
  // Link to Organization
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  
  reservations   Reservation[]
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}


enum PaymentFrequency {
  DAILY
  MONTHLY
  YEARLY
}


model Reservation {
  id          String   @id @default(uuid())
  
  startDate   DateTime
  endDate     DateTime
  status      ReservationStatus @default(PENDING)
  amount      Decimal          @db.Decimal(10, 2)
  frequency   PaymentFrequency @default(MONTHLY)
  
  // Relations
  unitId      String
  unit        Unit     @relation(fields: [unitId], references: [id])
  
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])

  payments    Payment[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

enum PaymentMethod {
  CASH
  BANK_TRANSFER
  CARD
  CHEQUE
  OTHER
}

model Payment {
  id            String   @id @default(uuid())
  amount        Decimal  @db.Decimal(10, 2)
  date          DateTime @default(now())
  method        PaymentMethod @default(CASH)
  reference     String?  // e.g. "Receipt #123" or "Transaction ID"
  notes         String?
  
  reservationId String
  reservation   Reservation @relation(fields: [reservationId], references: [id], onDelete: Cascade)
  
  createdAt     DateTime @default(now())
}